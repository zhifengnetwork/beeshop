<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>购物车-{$tpshop_config['shop_info_store_title']}</title>
    <meta name="keywords" content="{$tpshop_config['shop_info_store_keyword']}"/>
    <meta name="description" content="{$tpshop_config['shop_info_store_desc']}"/>
    <script src="__STATIC__/js/jquery-1.11.3.min.js" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/tpshop.css" />
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/base.css"/>
    <script src="__PUBLIC__/js/global.js"></script>
    <script src="__PUBLIC__/js/pc_common.js"></script>
    <script src="__PUBLIC__/js/layer/layer.js"></script>
    <link href="__STATIC__/css/common.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="__STATIC__/css/jh.css">
</head>
<body>
<include file="public/sign-header"/>
<div class="fn-cart-confirm">
    <!-- cart-title -->
    <div class="wrapper1190">
        <div class="order-header">
            <div class="layout after">
                <div class="fl">
                    <div class="logo pa-to-36 wi345">
                        <a href="/"><img src="__PUBLIC__/images/newLogo.png" alt=""></a>
                    </div>
                </div>
                <div class="fr">
                    <div class="pa-to-36 progress-area">
                        <div class="progress-area-wd" style="display:none">我的购物车</div>
                        <div class="progress-area-tx">填写核对订单信息</div>
                        <div class="progress-area-cg" style="display:none">成功提交订单</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- end cart-title -->
        <!-- end收货信息 -->
        <form name="cart2_form" id="cart2_form" method="post">
            <!--立即购买才会用到-s-->
            <input type="hidden" name="action" value="{$Request.param.action}">
            <input type="hidden" name="goods_id" value="{$Request.param.goods_id}">
            <input type="hidden" name="item_id" value="{$Request.param.item_id}">
            <input type="hidden" name="goods_num" value="{$Request.param.goods_num}">
            <!--立即购买才会用到-e-->
            <div class="layout be-table fo-fa ma-bo-45">
                <div class="con-info">
                    <div class="con-y-info ma-bo-35">
                        <h3>收货人信息<b>[<a href="javascript:void(0);" onClick="add_edit_address(0);">使用新地址</a>]</b></h3>

                        <div id="ajax_address"><!--ajax 返回收货地址--></div>
                        <h3 style="margin-top:30px">自提点</h3>
                        <div id="ajax_pickup"><!--ajax 返回自提点--></div>
                    </div>
                    <div class="con-y-info ma-bo-35 con-h">
                        <h3>发票信息<em>(请谨慎选择发票抬头，订单出库后不能修改)</em></h3>

<!--                        <div class="order-invoice-list">
                            <ul>
                                <li>
                                    <div class="invoice-main fl"><label for="dw">发票抬头:</label></div>
                                    <div class="invoice-sub fl">
                                        <label class="inv-label">
                                            <input class="officdw" type="text" name="invoice_title" placeholder="XXX单位 或 XX个人"/>
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>-->

  <div class="addremark">
        <div class="w1224">
            <div class="top_leg p ma-to-20">
                <span class="paragraph fl"><i class="ddd"></i>发票信息</span>
            </div>
            <div class="invoice-cont ma-to-20" id="changeinfo">
                <span id="span1" style="display:none">普通发票（纸质）</span>
                <span id="span2" style="display:none">个人</span>
                <span id="span3" style="display:none">明细</span>
                <span id="span4" >不开发票</span>
                <a onclick="invoice_dialog();" href="javascript:void(0);">修改</a>
            </div>
        </div>
    </div>




 <!--发票信息弹窗-s--->
    <div class="ui-dialog infom-dia">
        <div class="ui-dialog-title">
            <span>发票信息</span>
            <a class="ui-dialog-close" title="关闭">
                <span class="ui-icon ui-icon-delete"></span>
            </a>
        </div>
        <div class="ui-dialog-content" style="height: 600px">
            <div class="invoice-dialog">
                <div class="tab-nav p">
                    <ul>
                        <li>
                            <div class="item_select_t curtr">
                                <span>普通发票</span>
                                <b></b>
                            </div>
                        </li>
                        <!--							<li>
                                                                                        <div class="item_select_t">
                                                                                                <span>电子发票</span>
                                                                                                <b></b>
                                                                                        </div>
                                                                                </li>
                                                                                <li>
                                                                                        <div class="item_select_t">
                                                                                                <span>增值税发票</span>
                                                                                                <b></b>
                                                                                        </div>
                                                                                </li>-->
                    </ul>
                </div>
                <div class="zinvoice-tips">
                    <i></i>
                    <span class="tip-cont">开票金额不包优惠券和积分支付部分。<!--<a target="_blank" class="newadd" href="">发票信息相关问题&gt;&gt;</a>--></span>
                </div>
                <div class="ui-switchable-panel">
                    <div class="invoice_title p">
                        <span class="label">发票抬头：</span>
                        <div class="fl">
                            <input class="invoice_tt" type="text"  value="个人" onclick="hidediv();" id="personage" />
                            <div id="adddiv" class="invoice_tt" style="display:none">

                                <div class='fl' style='margin-left：-5px'> 
                                    <input class='invoice_tt' type='text' value='' id='invoice_title'/> 
                                    <a  onclick='save_invoice();'  class='btn-9'>保存</a>
                                    <a  onclick='togglediv();'  class='btn-9'>取消</a>
                                </div>

                            </div>
                            </br>
                            <a onclick="togglediv()" href="javascript:void(0);" id="addinvoice">新增单位发票</a>
                        </div>
                    </div>

                    <div class="invoice_title p">


                    </div>

                    <div id="ratepaying" style="display:none" class="invoice_title p">
                        <span class="label">纳税人编号：</span>
                        <div class="fl">
                            <input class="invoice_tt" type="text" value="" id="taxpayer"/>                         
                        </div>
                       
                    </div>
                    <div class="invoice_title p">
                        <span class="label">发票内容：</span>
                        <input type="hidden" name="invoice_desc" id="invoice_desc" value="">

                        <div class="fl">
                            <div class="tab-nav p" >
                                <ul id="invoice_class">
                                    <li>
                                        <div class="item_select_t curtr" id="no_invoice">
                                            <span>不开发票</span>
                                            <b></b>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item_select_t" id="detail_invoice">
                                            <span>明细</span>
                                            <b></b>
                                        </div>
                                    </li>

                                </ul>
                            </div>
                        </div>
                    </div>
                    <script type="text/javascript">
                        var invoice_type = $('#invoice_class');

                        $("#invoice_desc").val(invoice_type.find('.curtr').find('span').text());

                        invoice_type.find('li').click(function() {

                            invoice_type.find('div').attr("class", "item_select_t");
                            $("#invoice_desc").val($(this).find('span').text());
                            $(this).find('div').attr("class", "item_select_t curtr");

                        });
                        
                        
                       
            function hidediv() {
                $("#invoice_title").css({"border": ""});
                $("#personage").css({"border": "2px solid #e4393c"});
                $('#adddiv').hide();
                $("#ratepaying").hide();
               
            }
            function togglediv() {
                $("#personage").css({"border": ""});
                $("#invoice_title").css({"border": "2px solid #e4393c"});
                $('#adddiv').toggle();
                $("#ratepaying").toggle();
            }
            //保存发票
            function save_invoice() {
                var invoice_title = "";
                var invoice_desc = $("#invoice_desc").val();
                var data = {invoice_title: invoice_desc, invoice_desc: invoice_desc};
                if (!$('#ratepaying').is(":hidden")) {
                    invoice_title=$("#invoice_title").val()
                    if (invoice_title.length == 0) {
                        layer.msg("发票抬头不能为空", {icon: 2});
                        return false;
                    }                    
                    var taxpayer = $("#taxpayer").val();
                 
                    var data = {invoice_title: invoice_title, taxpayer: taxpayer, invoice_desc: invoice_desc};
                }
                
                $.post("{:U('Cart/save_invoice')}", data, function(json) {
                    var data = eval("(" + json + ")");
                });
//                 window.location.reload(); 
                $('#span2').text(invoice_title);                
              
             if (invoice_desc == "不开发票") {
                     $("#span1,#span2,#span3").hide();
                     $("#span4").show();
                }
                else{
                    $('#span3').text(invoice_desc);                     
                    $("#span4").hide();
                    $("#span1,#span2,#span3").show();
                }
                
                return true;
            }
                        
                        
                    </script>
                    <div class="invoice_title p">
                        <span class="label">&nbsp;</span>
                        <div class="fl">
                            <div class="op-btns  invoice_sendwithgift">
                                <a id="invoiceBtn" class="btn-1">保存</a>
                                <a onclick="$('.ui-dialog-close').trigger('click');" class="btn-9">取消</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--发票信息弹窗-e--->






                        <p class="tips"><em>注意：</em>如果商品由第三方卖家销售，发票内容由其卖家决定，发票由卖家开具并寄出</p>
                    </div>
                </div>
                <div class="sc-area">
                    <div class="dt-order-area">
                        <div class="order-pro-list">
                            <!--商品列表-->
                                <div class="order-pro-list">
                                    <div class="yxspy">
                                        <div class="hv">{$v[store_name]}</div>
                                        <div class="bv">
                                            <table border="0" cellpadding="0" cellspacing="0">
                                                <thead>
                                                <tr>
                                                    <th class="tr-pro">商品</th>
                                                    <th class="tr-price">单价（元）</th>
                                                    <//if condition="($user[discount] neq 1)">
                                                        <!--<th class="tr-price">会员折扣价</th>-->
                                                        <th class="tr-price"></th>
                                                    <///if>
                                                    <th class="tr-quantity">数量</th>
                                                    <th class="tr-subtotal">小计（元）</th>
                                                </tr>
                                                </thead>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="leiliste">
                                        <table width="100%" border="0" cellpadding="0" cellspacing="0">
                                            <tbody>
                                            <foreach name="cartList" item="v2" key="k">
                                                <tr>
                                                    <td class="tr-pro">
                                                        <ul class="pro-area-2">
                                                            <li>
                                                                <a title="{$v2.goods_name}" target="_blank" href="{:U('Home/Goods/goodsInfo',array('id'=>$v2[goods_id]))}" seed="item-name">{$v2.goods_name}</a>{$v2.spec_key_name}
                                                            </li>
                                                        </ul>
                                                    </td>
                                                    <!-- 预付订金商品的价格为空 -->
                                                    <td class="tr-price te-al">¥{$v2.goods_price}</td>
                                                    <!--<//if condition="($user[discount] neq 1)">-->
                                                        <!--<td class="tr-price te-al">¥{$v2.member_goods_price}</td>-->
                                                        <td class="tr-price te-al"></td>
                                                    <!--<///if>-->
                                                    <td class="tr-quantity te-al">{$v2.goods_num}</td>
                                                    <td rowspan="1" class="tr-subtotal te-al">
                                                        <p><b>￥{$v2.goods_fee}</b></p>
                                                    </td>
                                                </tr>
                                            </foreach>
                                            <tr>
                                                <td colspan="4"><span class="span_ored">优惠券:</span>
                                                    <input type="radio" onclick="ajax_order_price();" value="1" checked="" name="couponTypeSelect"
                                                           class="radio vam ma-ri-10">

                                                    <select onchange="ajax_order_price();" class="vam ou-no" id="coupon_id" name="coupon_id">
                                                        <option value="0">选择优惠券</option>
                                                        <foreach name="userCartCouponList" item="v3">
                                                            <if condition="$v3.coupon[able] eq 1">
                                                                <option value="{$v3['id']}">{$v3.coupon['name']}</option>
                                                            </if>
                                                        </foreach>
                                                    </select>
                                                    &nbsp;&nbsp;&nbsp;
                                                    <!--<input type="radio" value="2" id="couponTypeSelect" name="couponTypeSelect" class="radio vam ma-ri-10">-->
                                                    <input type="text" placeholder="请输入优惠券代码" class="texter vam span-150 ma-ri-10 he18 li-he-18" name="couponCode" id="couponCode">
                                                    <input type="button" onclick="wieldCouponCode();" value="兑换"
                                                           class="button-style-disabled-4 button-action-use-disabled te-al ou-no vam">
                                                </td>
                                                <td rowspan="1" class="tr-subtotal te-al">
                                                    <p>-￥<b id="coupon_price">0</b></p>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="4">
                                                    <span class="span_ored">选择物流:</span>
                                                    <select onchange="ajax_order_price();" class="vam ou-no" name="shipping_code">
                                                        <foreach name="shippingList" item="v4" key="k4">
                                                            <option value="{$v4.code}"  >{$v4.name}</option>
                                                        </foreach>
                                                    </select>
                                                </td>
                                                <td rowspan="1" class="tr-subtotal te-al">
                                                    <p>￥<b id="shipping_price">0</b></p>
                                                </td>
                                            </tr>
                                            <!--<tr>-->
                                                <!--<td colspan="4"><span class="span_ored">商家活动：</span></td>-->
                                                <!--<td rowspan="1" class="tr-subtotal te-al">-->
                                                    <!--<p>-￥<b id="store_order_prom_amount_{$v[store_id]}">0</b></p>-->
                                                <!--</td>-->
                                            <!--</tr>-->
                                            <!--<tr>-->
                                                <!--<td colspan="4"><span class="span_ored">积分抵扣：</span></td>-->
                                                <!--<td rowspan="1" class="tr-subtotal te-al">-->
                                                    <!--<p>-￥<b id="store_point_count_{$v[store_id]}">0</b></p>-->
                                                <!--</td>-->
                                            <!--</tr>-->
                                            <!--<tr>-->
                                                <!--<td colspan="4"><span class="span_ored">余额抵扣：</span></td>-->
                                                <!--<td rowspan="1" class="tr-subtotal te-al">-->
                                                    <!--<p>-￥<b id="store_balance_{$v[store_id]}">0</b></p>-->
                                                <!--</td>-->
                                            <!--</tr>-->
                                            <!--<tr>-->
                                                <!--<td colspan="4"><span class="span_ored">店铺合计(含运费)：</span></td>-->
                                                <!--<td rowspan="1" class="tr-subtotal te-al">-->
                                                    <!--<p>￥<b id="store_order_amount_{$v[store_id]}">0</b></p>-->
                                                <!--</td>-->
                                            <!--</tr>-->
                                                <tr>
                                                    <td colspan="5">
                                                    <span class="span_ored">给卖家留言:</span>
                                                <input class="span_text texter tapassa" type="text" name="user_note" onkeyup="checkfilltextarea('.tapassa','50')" />
                                                <span class="xianzd"><em id="zero">50</em>/50</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <br/>
                            <!--商品列表 end-->
                        </div>
                        <div class="order-pro-total">
                            <div class="fl wctmes">
                                <div class="syyouhui pa-to-15">
                                    <div class="duoxuk">
                                        <label class="fo-fa-ta">使用优惠券:</label>&nbsp;&nbsp;注：优惠券每次只能使用一张，不可多张混合使用,线下券兑换后如果不符合当前订单条件将不能使用。
                                    </div>
                                    <div class="byicd">
                                        <div class="zhiwfnka">
                                            <table border="0" cellpadding="0" cellspacing="0">
                                                <tbody>
                                                <tr>
                                                    <td>
                                                        <label class="fo-fa-ta">余额支付:</label>
                                                        <input type="text" id="user_money" name="user_money" class="texter vam span-150 ma-ri-10 he18 li-he-18" placeholder="请输入使用余额" onkeyup="this.value=/^\d+\.?\d{0,2}$/.test(this.value) ? this.value : ''"/>
                                                        <input type="button" class="button-style-disabled-4 button-action-use-disabled te-al ou-no vam" value="使用" onClick="wield(this);"/> 您的可用余额 ¥ {$user['user_money']}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <label class="fo-fa-ta">积分支付:</label>
                                                        <input type="text" id="pay_points" name="pay_points" class="texter vam span-150 ma-ri-10 he18 li-he-18" placeholder="请输入使用积分" onkeyup="this.value=this.value.replace(/[^\d]/g,'')"/>

                                                        <input type="button" class="button-style-disabled-4 button-action-use-disabled te-al ou-no vam" value="使用" onClick="wield(this);"/>
                                                        <?php echo tpCache('shopping.point_rate');?>
                                                        积分抵 1元 &nbsp;&nbsp; 您的可用积分 {$user['pay_points']} 分
                                                    </td>
                                                </tr>
                                                <input style="display:none" type="password" name="paypwd"/>
                                                <!--解决google浏览器识别text+password,自动填充已保存的账户密码-->
                                                <tr>
                                                    <td>
                                                        <label class="fo-fa-ta" for="paypwd">支付密码:</label>
                                                        <input type="password" id="paypwd" name="paypwd" class="texter vam span-150 ma-ri-10 he18 li-he-18" placeholder="请输入支付密码"/>
                                                        <if condition="empty($user.paypwd)">
                                                            请先<a href="{:U('User/paypwd')}" class="red">设置支付密码</a>
                                                        </if>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="fr wcnhy">
                                <div class="fzoubddv">
                                    <table width="100%" border="0" cellpadding="0" cellspacing="0">
                                        <tbody>
                                        <tr>
                                            <td class="tal">商品总金额：</td>
                                            <td class="tar">&nbsp;¥&nbsp;
                                                <em id="totalFee">{$cartPriceInfo.total_fee}</em>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="tal">运费：</td>
                                            <td class="tar">&nbsp;¥&nbsp;
                                                <em id="postFee">0.00</em>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="tal">使用优惠券：</td>
                                            <td class="tar">-&nbsp;¥&nbsp;
                                                <em><span id="couponFee">0.00</span> </em>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="tal">使用积分：</td>
                                            <td class="tar">-&nbsp;¥&nbsp;
                                                <em><span id="pointsFee">0.00</span> </em>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="tal">订单优惠：</td>
                                            <td class="tar">-&nbsp;¥&nbsp;
                                                <em><span id="order_prom_amount">0.00</span> </em>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="tal">使用余额:</td>
                                            <td class="tar">-&nbsp;¥&nbsp;
                                                <em><span id="balance">0.00</span> </em>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                    <p class="yifje-order">
		                            	<span class="p-subtotal-price"> 应付金额：
		                                    <b class="total">¥</b>
		                                    <b class="total" id="payables">0.00</b>
		                                </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="order-action-area te-al-ri">
                        <div class="woypdbe sc-acti-list">
                            <!--<span class="p-subtotal-price">应付总额：<b>¥<span class="vab" id="payableTotal">2276.00</span></b></span>-->
                            <a class="Sub-orders gwc-qjs" href="javascript:void(0);" onClick="submit_order();"><span>提交订单</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 提示切换省份 -->
<div id="changeProvince" style="display: none;">
    <div class="mask mask-cs-05 mask-4">
        <div class="mk-title">
            <h3>温馨提示</h3>
            <i data-x="1" class="mask-close-x changeAddrX"></i></div>
        <div class="mk-adc">
            <div class="cs-01"> 您目前所在的省份为<strong>上海</strong>，选择<strong>安徽省</strong>的收货地址后，您购买的商品及价格将发生变化。</div>
            <div class="cs-03">
                <button class="btn btn-red confirmChangeCity">切换省份</button>
                <button class="btn mask-close-x changeAddrX" data-x="1">取消</button>
            </div>
        </div>
    </div>
</div>
<!-- end 提示切换省份 -->
<!-- 提示配送商品 -->
<div id="sorryTipLayer" style="display:none;">
    <div class="tipLayerCont">
        <p class="tip">对不起，以下商品暂时无法送达至<b>江苏省</b><b>无锡市</b><b>锡山区</b></p>

        <div class="tipLayerList">
            <div class="listHead"><span class="name">商品名称</span> <span class="spec">规格</span> <span class="num">数量</span> <span class="price">金额</span></div>
            <div class="listCont"></div>
        </div>
    </div>
</div>
<!-- end 提示配送商品 -->
<!--footer-s-->
<div class="footer p">
    <include file="public/footer" />
</div>
<!--footer-e-->
<script>
    /**
     * 留言字数限制
     * tea ：要限制数字的class名
     * nums ：允许输入的最大值
     * zero ：输入时改变数值的ID
     */
    function checkfilltextarea(tea,nums){
        var len = $(tea).val().length;
        if(len > nums){
            $(tea).val($(tea).val().substring(0,nums));
        }
        var num = nums - len;
        num <= 0 ? $("#zero").text(0): $("#zero").text(num);  //防止出现负数
    }
    $(document).ready(function () {
        ajax_address(); // 获取用户收货地址列表
         self_motion_load();
    });

    /**
     * 新增修改收货地址
     * id 为零 则为新增, 否则是修改
     *  使用 公共的 layer 弹窗插件  参考官方手册 http://layer.layui.com/
     */
    function add_edit_address(id) {
        if (id > 0)
            var url = "/index.php?m=Home&c=User&a=edit_address&scene=1&call_back=call_back_fun&id=" + id; // 修改地址  '{:U('Home/User/add_address',array('scene'=>'1','call_back'=>'call_back_fun','id'=>id))}' //iframe的url /index.php/Home/User/add_address
        else
            var url = "/index.php?m=Home&c=User&a=add_address&scene=1&call_back=call_back_fun";	// 新增地址
        layer.open({
            type: 2,
            title: '添加收货地址',
            shadeClose: true,
            shade: 0.8,
            area: ['880px', '580px'],
            content: url,
        });
    }
    // 添加修改收货地址回调函数
    function call_back_fun(v) {
        layer.closeAll(); // 关闭窗口
        ajax_address(); // 刷新收货地址
    }

    // 删除收货地址
    function del_address(id) {
        layer.confirm('确定要删除吗？', {
                    btn: ['确定','取消'] //按钮
                }, function(index){
					layer.close(index);
                    // 确定
                    $.ajax({
                        url: "/index.php?m=Home&c=User&a=del_address&id=" + id,
                        success: function (data) {
                            ajax_address(); // 刷新收货地址
                            $('#ajax_pickup .order-address-list').removeClass('address_current');
							
                        }
                    });
                    layer.closeAll(); // 关闭窗口
                }, function(index){
                    layer.close(index);
                }
        );
    }

    /*
     * ajax 获取当前用户的收货地址列表
     */
    function ajax_address() {
        $.ajax({
            url: "{:U('Home/Cart/ajaxAddress')}",//+tab,
            success: function (data) {
                $("#ajax_address").html('');
                $("#ajax_address").append(data);
                if (data != '') {
                    // 有收货地址列表 再计算价钱
                    ajax_order_price(); // 计算订单价钱
                }else{
                    add_edit_address(0);
                }
            }
        });
    }

    // 切换收货地址
    function swidth_address(obj) {
        var province_id = $(obj).attr('data-province-id');
        var city_id = $(obj).attr('data-city-id');
        var district_id = $(obj).attr('data-district-id');
        if (typeof($(obj).attr('data-province-id')) != 'undefined') {
            ajax_pickup(province_id,city_id,district_id,0);
        }
        $(".order-address-list").removeClass('address_current');
        $(obj).parent().parent().parent().parent().parent().addClass('address_current');
        ajax_order_price(); // 计算订单价格
    }
    /**
     * 获取用户自提点和推荐自提点
     * @param type 1：用户自提点 ，0：用户自提点和推荐自提点
     * @param province_id 省
     * @param city_id 市
     * @param district_id 区
     */
    function ajax_pickup(province_id, city_id, district_id,show) {
        $.ajax({
            type: 'GET',
            url: "{:U('Home/Cart/ajaxPickup')}",//+tab,
            data: {province_id: province_id, city_id: city_id, district_id: district_id,show:show},
            success: function (data) {
                $("#ajax_pickup").html('');
                $("#ajax_pickup").append(data);
                ajax_order_price();
            }
        });
    }
    //更换自提点
    function replace_pickup(province_id, city_id, district_id) {
        var url = "/index.php?m=Home&c=Cart&a=replace_pickup&call_back=call_back_pickup&province_id="+province_id+"&city_id="+city_id+"&district_id="+district_id;
        layer.open({
            type: 2,
            title: '添加收货地址',
            shadeClose: true,
            shade: 0.8,
            area: ['880px', '580px'],
            content: url,
        });
    }
    // 添加自提点地址回调函数
    function call_back_pickup(province_id,city_id,district_id){
        layer.closeAll(); // 关闭窗口
        ajax_pickup(province_id, city_id, district_id,1);
    }
    // 获取订单价格
    function ajax_order_price() {
        $.ajax({
            type : "POST",
            url:"{:U('Home/Cart/cart3')}",//+tab,g
            data : $('#cart2_form').serialize()+"&act=order_price",// 你的formid
            dataType: "json",
            success: function(data){
                if(data.status != 1)
                {
                    //执行有误
                    layer.alert(data.msg, {icon: 2});
                    // 登录超时g
                    if(data.status == -100)
                        location.hrgef ="{:U('Home/User/login')}";
                    return false;
                }
               
                $("#postFee").text(data.result.postFee); // 物流费
                $("#shipping_price").text(data.result.postFee); // 物流费
                if(data.result.couponFee == null){
                    $("#couponFee").text(0);// 优惠券
                }else{
                    $("#couponFee").text(data.result.couponFee);// 优惠券
                }
                $("#coupon_price").text(data.result.couponFee);// 优惠券
                $("#balance").text(data.result.balance);// 余额
                $("#pointsFee").text(data.result.pointsFee);// 积分支付
                $("#payables").text(data.result.payables);// 应付
                $("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动
 
            }
        });
    }

    // 提交订单
    ajax_return_status = 1;
    function submit_order()
    {
        if(ajax_return_status == 0)
            return false;
        ajax_return_status = 0;
        $.ajax({
            type : "POST",
            url:"{:U('Home/Cart/cart3')}",//+tab,
            data : $('#cart2_form').serialize()+"&act=submit_order",// 你的formid
            dataType: "json",
            success: function(data){

                if(data.status != '1')
                {
                    // alert(data.msg); //执行有误
                    layer.alert(data.msg, {icon: 2});
                    // 登录超时
                    if(data.status == -100)
                        location.href ="{:U('Home/User/login')}";

                    ajax_return_status = 1; // 上一次ajax 已经返回, 可以进行下一次 ajax请求

                    return false;
                }
                layer.msg('订单提交成功，正在跳转!', {
                    icon: 1,   // 成功图标
                    time: 2000 //2秒关闭（如果不配置，默认是3秒）
                }, function(){ // 关闭后执行的函数
                    location.href = "/index.php?m=Home&c=Cart&a=cart4&order_id="+data.result; // 跳转到结算页
                });
            }
        });
    }

  //发票弹窗
    function invoice_dialog() {
        var dh = $(document).height();
        var dw = $(document).width();
        $('.ui-mask').height(dh).width(dw);
        $('.ui-dialog').show();
        $('.ui-mask').show();
        self_motion_load();

    }

    function self_motion_load() {
        $.get("{:U('Cart/invoice')}", function(json) {
            var data = eval("(" + json + ")");
            if (data.status > 0) {
                if(data.result.invoice_title!="个人"){
                    $('#invoice_title').val(data.result.invoice_title);
                    $("#invoice_desc").val(data.result.invoice_desc);
                    $("#taxpayer").val(data.result.taxpayer);
                    $('#adddiv').show();
                    $("#ratepaying").show();
                }

                if (data.result.invoice_desc == "不开发票") {
                        $("#span1,#span2,#span3").hide();
                        $("#span4").show();
                }else{
                        if(data.result.invoice_title!= ""){
                            $('#invoice_desc').val(data.result.invoice_desc);
                            $('#span2').text(data.result.invoice_title);
                            $('#span3').text(data.result.invoice_desc);
                            $("#span4").hide();
                            $("#span1,#span2,#span3").show();
                        }
                        $("#invoice_title").css({"border": "2px solid #e4393c"});
                        $("#personage").css({"border": ""});
                        $("#no_invoice").attr("class","item_select_t");
                        $("#detail_invoice").attr("class","item_select_t curtr");
                }
            }else{
                $("#span1,#span2,#span3").hide();
                $("#span4").show();
            }
        });
    }

    $(function() {
        $(document).on('click', '#invoiceBtn', function() {
            var input_invoice = $(this).parents('.ui-dialog-content').find('.invoice_tt');
//                $('#invoice_title').val(input_invoice.val());
            $('#cart2_form').find("input[name^='invoice_title']").attr('value', input_invoice.val());
            save_invoice() && $('.ui-dialog-close').trigger('click');

            var invoice_title = $("#invoice_title").val();
            var invoice_desc = $("#invoice_desc").val();

            if (invoice_title==""){
                invoice_title="个人";
            }

            $('#span2').text(invoice_title);
            $('#span3').text(invoice_desc);

            if (invoice_desc == "不开发票") {
                $("#span1,#span2,#span3").hide();
                $("#span4").show();
            }else{
                 $("#span1,#span2,#span3").show();
                $("#span4").hide();
            }

            $('.ui-dialog').hide();
            $('.ui-mask').hide();

        });
    })
     //关闭弹窗
    $(function() {
        $('.ui-dialog-close').click(function() {
            $('.ui-dialog').hide();
            $('.ui-mask').hide()
        })
    })
    function wield(obj){
        if($.trim($(obj).prev().val()) !=''){
//            layer.msg('正在计算金额...',{icon:1});
            ajax_order_price(); // 计算订单价钱
        }
    }
    //兑换优惠券
    function wieldCouponCode(){
        var couponCode = $('#couponCode').val();
        if(couponCode !=''){
            $.ajax({
                type : "POST",
                url:'/index.php?m=Home&c=Cart&a=cartCouponExchange&t='+Math.random(),
                data : {coupon_code:couponCode},
                dataType: "json",
                success: function(data){
                    if(data.status != 1){
                        layer.alert(data.msg, {icon: 2});
                        // 登录超时
                        if(data.status == -100){
                            location.href ="{:U('Mobile/User/login')}";
                            return false;
                        }
                    }else{
                        layer.alert(data.msg, {icon: 1},function () {
                            window.location.href=''
                        });
                    }
                }
            });
        }else{
            layer.alert('请输入兑换码！', {icon: 2});
        }
    }
</script>
</body>
</html>